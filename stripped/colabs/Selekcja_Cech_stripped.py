"""
# **Selekcja cech**
"""

"""
## **1. Research**
"""

"""
* ### **Soil moisture:**
"""

"""
"Soil moisture is not only the key factor linking precipitation, surface water, and groundwater, but is also the carrier of soil nutrient circulation and flow."

"The response of soil moisture to precipitation also influences the composition and function of ecosystems, especially in the most sensitive and fragile arid and semi-arid ecosystems where the potential evapotranspiration significantly exceeds the precipitation "

"**A large number of studies have clearly revealed the complexity of the response process of soil moisture to rainfall, which is affected by multiple factors such as water condition, topography, soil structure and vegetation**. Generally, rainfall has an obvious effect on shallow soil moisture, but with the deepening of soil depth, the resistance increases and the fluctuation of deep soil moisture decreases. Moreover, the range of variation is also controlled by the antecedent soil moisture conditions. Under the effect of slope gradient, soil water content usually increases along the downslope direction"

https://doi.org/10.1016/j.envres.2022.113608


"""

"""
""Soil moisture is affected by various factors including terrain, soil characteristics, climate and vegetation, and the effects of these change with time (e.g., rainfall patterns) and space (e.g., soil depth). **In arid and semi-arid regions, deep soil moisture is of particular importance to vegetation restoration and the evaluation of vegetation sustainability**"

https://doi.org/10.1017/S1755691018000671
"""

"""
"Climate change with an accompanying decrease in soil moisture is expected to have a significant impact on the sensitive, water-limited ecosystems of America's southwestern deserts. Already, studies have documented shifts in the distributions of competing grasses and shrubs in this region, potentially altering ecosystem function. (...) We found that across all years, average soil **water content** in the sandy soil of the region **was higher in soil layers 40-60 cm deep than in the top 20 cm**, and **highest in the deepest layers down to 100 cm**."

https://ui.adsabs.harvard.edu/abs/2016AGUFM.H31E1439T/abstract
"""

"""
"Soil moisture is a **key variable** in dryland ecosystems since it determines the occurrence and duration of vegetation water stress and affects the development of weather patterns including rainfall. However, the lack of ground observations of soil moisture and rainfall dynamics in many drylands has long been a major obstacle in understanding ecohydrological processes in these ecosystems. **It is so uncertain to what extent rainfall controls soil moisture dynamics in fog dominated dryland systems**."

"Typically, precipitation is the major source of soil moisture in drylands, though **in some fog dominated systems, the non-rainfall water (e.g., fog and dew) can exceed annual rainfall**. Dryland near-surface climate is affected by soil moisture, which has been revealed as a major factor contributing to the occurrence of extremely high temperature and drought weather. **Therefore, understanding interactions between soil moisture and precipitation is critical to predict the response of dryland ecosystems to global environmental changes.**"

https://doi.org/10.1371/journal.pone.0164982
"""

"""
"**According to the UNCCD, soil moisture is another key parameter that should be monitored**, because it is an indicator of water scarcity and vegetation stress. Soil moisture data can also be used for assessing drought risk."

https://phys.org/news/2009-10-satellite-instrumental-combating-desertification.html
"""

"""
**Factors Affecting Soil Water:**

1. Texture: Finer the texture, more is the pore space and also surface area, greater is the retention of water.

2. Structure: Well-aggregated porous structure favors better porosity, which in turn enhance water retention.

3. Organic matter: Higher the organic matter more is the water retention in the soil.

4. Density of soil: Higher the density of soil, lower is the moisture content.

5. Temperature: Cooler the temperature, higher is the moisture retention.

6. Salt content: More the salt content in the soil less is the water available to the plant.

7. Depth of soil: More the depth of soil more is the water available to the plant.

8. Type of clay: The 2:1 type of day increases the water retention in the soil.

https://agriinfo.in/factors-affecting-soil-water-265/
"""

"""
"Stages of the Desertification Process (..)
Stage 5: Soil degradation and desertification. The loss of soil volume and **decrease in soil moisture** to the extent that any living form of organism, which is useful for the human and its environment, can survive."

https://www.mdpi.com/2306-5338/8/1/47
"""

"""
* ### **Potential Evapotranspiration:**
"""

"""
"The Aridity Index (AI) is used to define arid, semiarid, and dry subhumid areas, other than polar and subpolar regions. AI is the ratio of annual precipitation (P) to **potential evapotranspiration** (PET), ranging from 0.03 to 0.65 (Table 1). In general, when the ratio is lower than 0.03, this indicates permanent desertification, whereas when the ratio is higher than 0.65 indicates no desertification"
"""

"""
![tabelaPET.png](images/tabelaPET.png)
"""

"""

https://www.mdpi.com/2306-5338/8/1/47

https://wad.jrc.ec.europa.eu/patternsaridity
"""

"""
**Potential evapotranspiration** is the amount of evapotranspiration that is expected over a surface with no limitaion of water.
Actual Evapotranspiration is amount of evapotranspiration that actually occurs when water is limited.
PET can be identified as the ability of the environment to take up the water from the land and transfer it to gas; also, PET is the maximum amount of water that is going to evaporate when there is available water, such as in a lake. **PET is a function of relative humidity, solar radiation, water availability, wind, and temperature.** AET or ET is how much water is going to evaporate when there is a water limitation. AET is a function of vegetation cover, root, and soil.

The potential evapotranspiration concept was first introduced in the late 1940s. It was defined as “the amount of evapotranspiration in a given time by a large vegetation of short green crop, completely shading the ground, of uniform height and with adequate moisture at all the times in the soil”. The major objective in bringing this “potential” evapotranspiration concept was to remove the effects specific to crops in the evapotranspiration process.
The notion of PET was well accepted by the scientific fraternity, and it became the focal idea in estimating crop water use for a long time. After some time, however, certain limitations cropped up. In the definition of PET, the ET rate was not related to a specific crop. The main confusion with PET was that there were many types of crops that fitted into the description of a ‘short green crop’, and one might be confused as to which short crop should be selected! Having considered the ambiguities and limitations of PET, by the early 1980s, the concept of “reference crop evapotranspiration” (ETo) was introduced.
The major objective of introducing ETo was to assess the evapotranspiration demand of the atmosphere independently without considering the effects of crops, cultivar differences, crop development, and management practices.

https://www.researchgate.net/post/Difference_between_the_Actual_Evapotranspiration_AET_and_Potential_Evapotranspiration_PET
"""

"""
"The vegetation of the desert is sparse and uses little water
because water is deficient. If more water were available, the
vegetation would be less sparse and would use more water.
There is a distinction then, between the amount of water that
actually transpiresand evaporates and that which would tran-
spire and evaporate if it were available.
Since Ee representsthe value of ET which would prevail
under optimal growing conditions, Thornthwaite [1948, p.
75] concludes:
It is now apparent that the actual evaporationand transpiration
from the soil is not what must be comparedwith precipitation in
order to obtain a moisture index, but, rather, the potential
evapotranspiration. Where precipitation is exactly the same as
potential evapotranspirationall the time and water is available
just as needed, there is neither water deficiency nor water
excess, and the climate is neither moist nor dry. As water
deficiencybecomeslarger with respect to potential evapotrans-
piration, the climate becomes arid"
"""

"""
## **2. Histogramy dla wybranych punktów**
"""

!apt-get install openjdk-8-jdk-headless -qq > /dev/null
!wget -q dlcdn.apache.org/spark/spark-3.5.0/spark-3.5.0-bin-hadoop3.tgz
!tar xf spark-3.5.0-bin-hadoop3.tgz
!pip install -q findspark

import os
os.environ["JAVA_HOME"] = "/usr/lib/jvm/java-8-openjdk-amd64"
os.environ["SPARK_HOME"] = "/content/spark-3.5.0-bin-hadoop3"

import findspark
findspark.init()
from pyspark.sql.types import IntegerType, FloatType, StringType, StructType
from pyspark.sql import SparkSession, DataFrame
from pyspark.sql import functions as F

import pandas as pd
import matplotlib.pyplot as plt


spark = (
         SparkSession.builder
        .master("local")
        .appName("Colab")
        .config('spark.ui.port', '4050')
        .getOrCreate()
)


from google.colab import drive
drive.mount('/content/drive')


sampled = pd.read_csv('/content/drive/MyDrive/BigMess/NASA/sampled_NASA_200k.csv')

schemat = StructType()
for i in sampled.columns:
  if i == "Date":
    schemat = schemat.add(i, StringType(), True)
  else:
    schemat = schemat.add(i, FloatType(), True)

nasa = spark.read.format('csv').option("header", True).schema(schemat).load('/content/drive/MyDrive/BigMess/NASA/NASA.csv')
nasa.show(5)



nasa.createOrReplaceTempView("nasa")
nasa = (
    nasa
    .withColumn('Year', (F.col('Date') / 100).cast('int'))
    .withColumn('Month', F.col('Date') % 100)
    .drop('Date')
)
nasa.show(5)


nasa2 = nasa.where((nasa.Year.isin([2009, 2011, 2012, 2013, 2017])))
nasa2.show(5)
#Obszary pustynne:                             #wspolrzedne pustyn i niepustyn pochodza z notatnika dot. klasyfikacji pustyn (nie mam pewnosci, czy sa dobre...)
CD = nasa2.where((nasa2.lon>-104)&(nasa2.lon<-102)&(nasa2.lat>30)&(nasa2.lat< 31)).toPandas()
CP = nasa2.where((nasa2.lon>-110.5)&(nasa2.lon<-108.5)&(nasa2.lat>39)&(nasa2.lat< 40.5)).toPandas()
GBD = nasa2.where((nasa2.lon>-116)&(nasa2.lon<-114)&(nasa2.lat>40)&(nasa2.lat< 41.5)).toPandas()

#Obszary pośrednine:
CD_przejsciowe = nasa2.where((nasa2.lon>-106.5)&(nasa2.lon<-104.5)&(nasa2.lat>32.5)&(nasa2.lat< 33.5)).toPandas()
CP_przejsciowe = nasa2.where((nasa2.lon>-109)&(nasa2.lon<-107)&(nasa2.lat>37.5)&(nasa2.lat< 39)).toPandas()
GBD_przejsciowe = nasa2.where((nasa2.lon>-115)&(nasa2.lon<-113)&(nasa2.lat>42.5)&(nasa2.lat< 44)).toPandas()

#Obszary niepustynne:
niepustynia_obok_CD = nasa2.where((nasa2.lon>-109.5)&(nasa2.lon<-107.5)&(nasa2.lat>33)&(nasa2.lat< 34)).toPandas()
niepustynia_obok_CP = nasa2.where((nasa2.lon>-107)&(nasa2.lon<-105)&(nasa2.lat>9)&(nasa2.lat< 40.5)).toPandas()
niepustynia_obok_GBD = nasa2.where((nasa2.lon>-124)&(nasa2.lon<-122)&(nasa2.lat>40)&(nasa2.lat< 41)).toPandas()


def plot_histogram(ax, data, column, title, color):
    ax.hist(data[column], bins=20, color=color, edgecolor="black")
    ax.set_title(title)
    ax.set_xlabel(column)
    ax.set_ylabel("Frequency")
    ax.set_xlim(min(min(CD[column]), min(CD_przejsciowe[column]), min(niepustynia_obok_CD[column]),
                    min(CP[column]), min(CP_przejsciowe[column]), min(niepustynia_obok_CP[column]),
                    min(GBD[column]), min(GBD_przejsciowe[column]), min(niepustynia_obok_GBD[column])),
                max(max(CD[column]), max(CD_przejsciowe[column]), max(niepustynia_obok_CD[column]),
                    max(CP[column]), max(CP_przejsciowe[column]), max(niepustynia_obok_CP[column]),
                    max(GBD[column]), max(GBD_przejsciowe[column]), max(niepustynia_obok_GBD[column])))

def plot_feature(column):

  fig, axes = plt.subplots(3, 3, figsize=(15, 15))

  plot_histogram(axes[0, 0], CD, column, "CD_pustynia", "orange")
  plot_histogram(axes[0, 1], CD_przejsciowe, column, "CD_pustynia/nie-pustynia", "yellow")
  plot_histogram(axes[0, 2], niepustynia_obok_CD, column, "CD_nie-pustynia", "green")

  plot_histogram(axes[1, 0], CP, column, "CP_pustynia", "orange")
  plot_histogram(axes[1, 1], CP_przejsciowe, column, "CP_pustynia/nie-pustynia", "yellow")
  plot_histogram(axes[1, 2], niepustynia_obok_CP, column, "CP_nie-pustynia", "green")

  plot_histogram(axes[2, 0], GBD, column, "GBD_pustynia", "orange")
  plot_histogram(axes[2, 1], GBD_przejsciowe, column, "GBD_pustynia/nie-pustynia", "yellow")
  plot_histogram(axes[2, 2], niepustynia_obok_GBD, column, "GBD_nie-pustynia", "green")

  plt.tight_layout()
  plt.show()


"""
* **SoilM_0_10cm** : Soil moisture content (0-10cm)
"""

plot_feature('SoilM_0_10cm')


print(CD['SoilM_0_10cm'].quantile(0.75), CD_przejsciowe['SoilM_0_10cm'].quantile(0.75), niepustynia_obok_CD['SoilM_0_10cm'].quantile(0.75))
print(CP['SoilM_0_10cm'].quantile(0.75), CP_przejsciowe['SoilM_0_10cm'].quantile(0.75), niepustynia_obok_CP['SoilM_0_10cm'].quantile(0.75))
print(GBD['SoilM_0_10cm'].quantile(0.75), GBD_przejsciowe['SoilM_0_10cm'].quantile(0.75), niepustynia_obok_GBD['SoilM_0_10cm'].quantile(0.75))


"""
* **SoilM_10_40cm** : Soil moisture content (10-40cm)
"""

plot_feature('SoilM_10_40cm')


"""
* **SoilM_40_100cm** : Soil moisture content (40-100cm)
"""

plot_feature('SoilM_40_100cm')


"""
* **SoilM_0_100cm**: Soil moisture content (0-100cm)
"""

plot_feature('SoilM_0_100cm')


"""
* **SoilM_100_200cm**: Soil moisture content (100-200cm)
"""

plot_feature('SoilM_100_200cm')


"""
* **RootMoist**: Root zone soil moisture

"""

plot_feature('RootMoist')


"""
* **SMLiq_10_40cm**: Liquid soil moisture content (10-40cm)
"""

plot_feature('SMLiq_10_40cm')


"""
* **SMLiq_40_100cm**: Liquid soil moisture content (40-100cm)
"""

plot_feature('SMLiq_40_100cm')


"""
* **SMLiq_100_200cm**: Liquid soil moisture content (100-200cm)
"""

plot_feature('SMLiq_100_200cm')


"""
* **SMAvail_0_200cm**: Soil moisture availability (0-200cm)
"""

plot_feature('SMAvail_0_200cm')


"""
## **3. Wybrane cechy** :
"""

"""
Oprócz wcześniej wybranych kolumn (Rainf, Evap, AvgSurfT, Albedo, SoilT_40_100cm, GVEG) proponuję następujące kolumny:
* PotEvap
* RootMoist
* SoilM_100_200cm
"""



